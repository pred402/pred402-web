datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Disable prepared statements for Supabase Transaction Pooler
  // See: https://www.prisma.io/docs/orm/overview/databases/supabase#pgbouncer
  directUrl = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

generator zod {
  provider         = "zod-prisma-types"
  output           = "./zod"
  createInputTypes = true
  addIncludeType   = false
  addSelectType    = false
}

generator json {
  provider = "prisma-json-types-generator"
}

model User {
  id                 String           @id @default(cuid())
  name               String
  email              String
  emailVerified      Boolean
  image              String?
  createdAt          DateTime
  updatedAt          DateTime
  username           String?
  role               String?
  banned             Boolean?
  banReason          String?
  banExpires         DateTime?
  onboardingComplete Boolean          @default(false)
  paymentsCustomerId String?
  locale             String?
  twoFactorEnabled   Boolean?
  sessions           Session[]
  accounts           Account[]
  passkeys           Passkey[]
  invitations        Invitation[]
  purchases          Purchase[]
  members            Member[]
  twofactors         TwoFactor[]
  aiChats            AiChat[]
  walletAddresses    WalletAddress[]
  solanaThemes       SolanaTheme[]
  agents             Agent[]

  @@unique([email])
  @@unique([username])
  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String?

  activeOrganizationId String?

  token     String
  createdAt DateTime
  updatedAt DateTime

  @@unique([token])
  @@map("session")
}

model Account {
  id           String    @id @default(cuid())
  accountId    String
  providerId   String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken  String?   @db.Text
  refreshToken String?   @db.Text
  idToken      String?   @db.Text
  expiresAt    DateTime?
  password     String?

  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

// better-auth 用户可同时使用多个链的多个钱包地址登录
model WalletAddress {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  address   String   @unique
  chainId   Int      @map("chain_id")
  isPrimary Boolean? @default(false) @map("is_primary")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(references: [id], fields: [userId], onDelete: Cascade)

  @@index([userId])
  @@map("wallet_address")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String   @db.Text
  expiresAt  DateTime

  createdAt DateTime?
  updatedAt DateTime?

  @@map("verification")
}

model Passkey {
  id           String    @id @default(cuid())
  name         String?
  publicKey    String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialID String
  counter      Int
  deviceType   String
  backedUp     Boolean
  transports   String?
  createdAt    DateTime?

  @@map("passkey")
}

model TwoFactor {
  id          String @id @default(cuid())
  secret      String
  backupCodes String
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("twoFactor")
}

model Organization {
  id                 String       @id @default(cuid())
  name               String
  slug               String?
  logo               String?
  createdAt          DateTime
  metadata           String?
  paymentsCustomerId String?
  members            Member[]
  invitations        Invitation[]
  purchases          Purchase[]
  aiChats            AiChat[]

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime

  @@unique([organizationId, userId])
  @@map("member")
}

model Invitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

enum PurchaseType {
  SUBSCRIPTION
  ONE_TIME
}

model Purchase {
  id             String        @id @default(cuid())
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String?
  type           PurchaseType
  customerId     String
  subscriptionId String?       @unique
  productId      String
  status         String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([subscriptionId])
  @@map("purchase")
}

model AiChat {
  id             String        @id @default(cuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  title          String?
  /// [Array<{role: "user" | "assistant"; content: string;}>]
  messages       Json          @default("[]") /// @zod.custom.use(z.array(z.object({ role: z.enum(['user', 'assistant']), content: z.string() })))
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("ai_chat")
}

// Event 和 Market 表已删除，使用 SolanaTheme 替代

/**
 * Agent 表
 * 存储 AI Agent 信息，包括链上私钥用于创建和管理 agent
 */
model Agent {
  id             String   @id @default(cuid()) // Agent 主键，用作 Solana 链上的 agent_id
  agentId        Int?     @unique @map("agent_id") // Solana 链上的 agent ID（创建后回填）
  agentPda       String?  @unique @map("agent_pda") // Solana PDA 地址
  slug           String   @unique // 对外展示或 URL 使用的唯一标识
  name           String // Agent 名称
  description    String? // Agent 说明，描述策略或定位
  avatarUrl      String?  @map("avatar_url") // 头像地址
  privateKey     String   @map("private_key") // Agent 私钥（Base58编码）用于链上签名
  authorityPubkey String  @map("authority_pubkey") // Agent 公钥地址
  metadataUri    String?  @map("metadata_uri") // 元数据 URI
  configId       Int      @default(1) @map("config_id") // Config ID（默认1）
  isActive       Boolean  @default(true) @map("is_active") // 是否可用
  txSignature    String?  @map("tx_signature") // 创建时的交易签名
  createdById    String?  @map("created_by_id") // 创建者用户 ID
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  createdBy User? @relation(fields: [createdById], references: [id])

  @@index([agentId])
  @@index([slug])
  @@map("agents")
}

/**
 * Solana 链上 Theme 表
 * 存储在 Solana 区块链上创建的预测主题
 */
model SolanaTheme {
  id              String   @id @default(cuid())
  themeId         Int      @unique @map("theme_id") // Solana 链上的 theme ID
  themePda        String   @unique @map("theme_pda") // Solana PDA 地址
  title           String // 主题标题
  description     String? // 主题描述
  metadataUri     String   @map("metadata_uri") // 元数据 URI
  endTime         DateTime @map("end_time") // 投注结束时间
  resolutionTime  DateTime @map("resolution_time") // 结算时间
  totalOptions    Int      @map("total_options") // 选项总数
  status          String   @default("ACTIVE") // 状态: ACTIVE, RESOLVED, CANCELLED
  txSignature     String   @map("tx_signature") // 创建时的交易签名
  createdById     String?  @map("created_by_id") // 创建者用户 ID
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  options     SolanaThemeOption[] // 关联的选项
  createdBy   User?               @relation(fields: [createdById], references: [id])

  @@index([themeId])
  @@index([status])
  @@map("solana_themes")
}

/**
 * Solana Theme 选项表
 * 存储每个 Theme 的选项信息
 */
model SolanaThemeOption {
  id              String   @id @default(cuid())
  themeId         String   @map("theme_id") // 关联的 theme
  optionIndex     Int      @map("option_index") // 选项索引 (0-based)
  label           String // 选项标签
  labelUri        String   @map("label_uri") // 选项元数据 URI
  optionStatePda  String   @map("option_state_pda") // Solana option state PDA
  optionVaultPda  String   @map("option_vault_pda") // Solana option vault PDA
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  theme SolanaTheme @relation(fields: [themeId], references: [id], onDelete: Cascade)

  @@unique([themeId, optionIndex])
  @@index([themeId])
  @@map("solana_theme_options")
}
